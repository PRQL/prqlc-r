version: "3"

env:
  NOT_CRAN: true

vars:
  MANIFEST: src/rust/Cargo.toml
  CARGO_LOCK: src/rust/Cargo.lock
  R_SOURCE: R/*
  VIGNETTES: vignettes/**/*.Rmd
  RUST_SOURCE: src/rust/src/**/*.rs

tasks:
  setup-dev:
    desc: Install tools for development.
    deps:
      - install-r-tools
      - install-rust-tools

  install-r-tools:
    internal: true
    env:
      PKG_SYSREQS: FALSE
    desc: Install R packages for development.
    cmds:
      - Rscript -e
        'pak::local_install_deps(dependencies = c("all", "Config/Needs/dev", "Config/Needs/website"))'

  install-rust-tools:
    internal: true
    desc: Install Rust packages for development.
    cmds:
      - cargo install cargo-license

  build-all:
    desc: Build the R package, generate documents, run all tests, and update files.
    deps:
      - build-documents
    cmds:
      - task: test-all
      - task: build-license-note
      - task: build-readme

  test-all:
    desc: Run all tests.
    cmds:
      - task: test-source
      - task: test-examples
      - task: test-vignettes

  test-source:
    desc: Run all tests for source.
    internal: true
    sources:
      - tests/**/*
      - "{{.R_SOURCE}}"
      - src/Makevars*
      - configure*
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e 'devtools::load_all(); devtools::test()'

  test-examples:
    desc: Check if examples can be run.
    internal: true
    sources:
      - "{{.R_SOURCE}}"
      - src/Makevars*
      - configure*
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e 'devtools::load_all(); devtools::run_examples()'

  test-vignettes:
    desc: Check if vignettes can be rendered.
    internal: true
    sources:
      - "{{.VIGNETTES}}"
      - "{{.R_SOURCE}}"
      - src/Makevars*
      - configure*
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e
        'devtools::load_all();
        list.files("vignettes/", pattern = r"(\.Rmd$)", recursive = TRUE, full.names = TRUE) |>
          purrr::walk(\(x) rmarkdown::render(x, output_dir = tempdir()))'

  build-documents:
    desc: Build the R package and generate documents.
    internal: true
    sources:
      - "{{.R_SOURCE}}"
    generates:
      - man/*.Rd
    status:
      - Rscript -e 'if (desc::desc_get("RoxygenNote") < packageVersion("roxygen2")) quit(status = 1)'
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e 'devtools::document()'

  build-extendr-wrappers:
    internal: true
    desc: Build the extendr wrappers.
    sources:
      - src/Makevars*
      - configure*
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    generates:
      - R/extendr-wrappers.R
    status:
      - Rscript -e 'if (desc::desc_get("Config/rextendr/version") < packageVersion("rextendr")) quit(status = 1)'
    cmds:
      - Rscript -e 'rextendr::document()'

  build-license-note:
    internal: true
    desc: Build LICENSE.note
    sources:
      - "{{.CARGO_LOCK}}"
    generates:
      - LICENSE.note
    cmds:
      - Rscript -e 'rextendr::write_license_note(force = TRUE)'

  build-readme:
    internal: true
    desc: Build README.md
    sources:
      - README.Rmd
      - "{{.R_SOURCE}}"
      - src/Makevars*
      - configure*
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    generates:
      - README.md
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e
        'devtools::load_all();
        rmarkdown::render(input = "README.Rmd", output_file = "README.md")'

  test-snapshot-accept:
    desc: Accept all test snapshots. (Shortcut to accept snapshots after running tests)
    cmds:
      - Rscript -e 'testthat::snapshot_accept()'

  lint-and-format:
    desc: Lint and auto-format R and Rust code.
    deps:
      - lint-and-format-r
      - lint-and-format-rust

  lint-and-format-r:
    internal: true
    desc: Lint and auto-format R code.
    sources:
      - "{{.R_SOURCE}}"
      - "{{.VIGNETTES}}"
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e
        'devtools::load_all();
        lintr::lint_package();
        styler::style_pkg()'

  lint-and-format-rust:
    internal: true
    desc: Lint and auto-format Rust code.
    sources:
      - "{{.MANIFEST}}"
      - "{{.CARGO_LOCK}}"
      - "{{.RUST_SOURCE}}"
    cmds:
      - cargo clippy --manifest-path {{.MANIFEST}}
      - cargo fmt --manifest-path {{.MANIFEST}}

  release-prep:
    desc: "Prepare for a release. args: VERSION: major, minor, or patch"
    deps:
      - build-all
      - lint-and-format
    cmds:
      - Rscript -e '
        usethis::use_version(which = "{{.VERSION}}");
        usethis::use_cran_comments()'
