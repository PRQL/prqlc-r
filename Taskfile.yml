version: "3"

env:
  NOT_CRAN: true

tasks:
  setup-dev:
    desc: Install tools for development.
    deps:
      - install-r-tools
      - install-rust-tools

  install-r-tools:
    internal: true
    desc: Install R packages for development.
    cmds:
      - Rscript -e
        'pak::repo_add(extendr = "https://extendr.r-universe.dev");
        pak::local_install_deps(dependencies = c("all", "Config/Needs/dev", "Config/Needs/website"))'

  install-rust-tools:
    internal: true
    desc: Install Rust packages for development.
    cmds:
      - cargo install cargo-license

  build-all:
    desc: Build the R package, generate documents, run all tests, and update files.
    deps:
      - build-documents
    cmds:
      - task: test-all
      - task: build-license-note
      - task: build-readme

  test-all:
    desc: Run all tests.
    cmds:
      - task: test-source
      - task: test-vignettes

  test-source:
    desc: Run all tests for source.
    internal: true
    sources:
      - tests/**/*
      - R/*
      - src/Makevars*
      - src/rust/Cargo.toml
      - src/rust/src/**/*.rs
    cmds:
      - Rscript -e 'devtools::load_all(); devtools::test()'

  test-vignettes:
    desc: Check if vignettes can be rendered.
    internal: true
    sources:
      - vignettes/**/*.Rmd
      - R/*
      - src/Makevars*
      - src/rust/Cargo.toml
      - src/rust/src/**/*.rs
    cmds:
      - Rscript -e
        'devtools::load_all();
        list.files("vignettes/", pattern = r"(\.Rmd$)", recursive = TRUE, full.names = TRUE) |>
          purrr::walk(\(x) rmarkdown::render(x, output_dir = tempdir()))'

  build-documents:
    desc: Build the R package and generate documents.
    internal: true
    sources:
      - R/*
    generates:
      - man/*.Rd
    status:
      - Rscript -e 'if (desc::desc_get("RoxygenNote") < packageVersion("roxygen2")) quit(status = 1)'
    deps:
      - build-extendr-wrappers
    cmds:
      - Rscript -e 'devtools::document()'

  build-extendr-wrappers:
    internal: true
    desc: Build the extendr wrappers.
    sources:
      - src/Makevars*
      - src/rust/Cargo.toml
      - src/rust/src/**/*.rs
    generates:
      - R/extendr-wrappers.R
    status:
      - Rscript -e 'if (desc::desc_get("Config/rextendr/version") < packageVersion("rextendr")) quit(status = 1)'
    cmds:
      - Rscript -e 'rextendr::document()'

  build-license-note:
    internal: true
    desc: Build LICENSE.note
    sources:
      - src/rust/Cargo.lock
      - dev/generate-license-note.R
    generates:
      - LICENSE.note
    cmds:
      - Rscript dev/generate-license-note.R

  build-readme:
    internal: true
    desc: Build README.md
    sources:
      - README.Rmd
      - R/*
      - src/Makevars*
      - src/rust/Cargo.toml
      - src/rust/src/**/*.rs
    generates:
      - README.md
    cmds:
      - Rscript -e
        'devtools::load_all();
        rmarkdown::render(input = "README.Rmd", output_file = "README.md")'

  test-snapshot-accept:
    desc: Accept all test snapshots. (Shortcut to accept snapshots after running tests)
    cmds:
      - Rscript -e 'testthat::snapshot_accept()'
