#!/usr/bin/env sh

NOT_CRAN=${NOT_CRAN:-"false"}
LIBPRQLR_BUILD=${LIBPRQLR_BUILD:-""}
LIBNAME="libprqlr.a"

export PATH="$PATH:$HOME/.cargo/bin"

check_cargo() {
  if [ ! "$(command -v cargo)" ]; then
    echo "----------------------- [RUST NOT FOUND]---------------------------"
    echo "The 'cargo' command was not found on the PATH. Please install rustc"
    echo "from: https://www.rust-lang.org/tools/install"
    echo ""
    echo "Alternatively, you may install cargo from your OS package manager:"
    echo " - Debian/Ubuntu: apt-get install cargo"
    echo " - Fedora/CentOS: dnf install cargo"
    echo " - macOS: brew install rustc"
    echo "-------------------------------------------------------------------"
    echo ""
    exit 1
  fi
}

check_bin_lib() {
  if [ "${NOT_CRAN}" = "true" ] && [ -z "${LIBPRQLR_BUILD}"  ]; then
    LIBPRQLR_BUILD="false"
  fi

  if [ "${LIBPRQLR_BUILD}" = "false" ] && [ -f "tools/lib-sums.tsv" ] && [ ! -f "tools/${LIBNAME}" ] ; then
    echo "Try to download pre-built binary..."
    Rscript "tools/prep-lib.R" || echo "Failed to download pre-built binary..."
  fi

  if [ "${LIBPRQLR_BUILD}" = "false" ] && [ -f "tools/${LIBNAME}" ]; then
    echo "----------------------- [LIBRARY FOUND]---------------------------"
    echo "The library was found in the tools directory. No need to build it."
    echo "-------------------------------------------------------------------"
    echo ""
    exit 0
  fi
}

check_bin_lib
check_cargo

exit 0
